import{_ as e,N as l,E as a,ao as t,c as u,ah as s,b as r}from"./index.1672389691407.js";import{g as i}from"./dept.1672389691407.js";import{b as n,a as o}from"./permission.1672389691407.js";import{P as d}from"./index.16723896914073.js";import{f as m,$ as p,k as c,j as h,c as y,a as k,W as L,P as f,ay as g,az as F,aA as b,aD as q,a3 as v,o as D,O as _,F as S,a5 as I,T as V,u as A,U as T,i as w}from"./vue.1672389691407.js";import{e as C}from"./events.1672389691407.js";const U=e=>(g("data-v-ed58e97a"),e=e(),F(),e),x={"class":"system-dict-container"},M={"class":"arch-pro-layout page-container"},G={"class":"arch-pro-content-container"},j=U((()=>k("div",{"class":"per-title"},[
k("em"),
T(" 数据权限设置 ")],-1))),N={"class":"per-form"},z=T("按用户组"),O=T("按用户"),P=T("关闭"),E=T("本部门可见"),R=T("多部门可见"),J={"class":"sql"},Q=U((()=>k("div",{"class":"sql_title"}," 自定义规则 ",-1))),W={"class":"sql_body"},$={"class":"w650"},B={"class":"sql_left w650"},H={key:0,"class":"sql_line"},K={"class":"sql_right"},X={"class":"footer"},Y=T("取消"),Z=T("保存");var ee=e({__name:"editPermission",setup(e){const g=m(null),F=m(null),T=m(null),{proxy:U}=w(),ee=b(),le=q(),ae=p({ruleForm:{id:"",linkType:"0",linkuserId:"",linkGroup:"",linkUser:"",menuCreateList:[],menuSettleList:[],isDeptAuth:"0",authDeptList:[],menuDeptList:[],menuSqlList:[{diySql:"",sqlMenuList:[]}]},menulist:[],userGroupList:[],deptTree:[],menuProps:{children:"children",label:"name"},options:[]}),te={linkType:[{required:!0,message:"请选择关联账号",trigger:"change"}],linkGroup:[{required:!0,message:"请选择用户组关联账号",trigger:"change"}],linkuserId:[{required:!0,message:"请选择用户关联账号",trigger:"change"}],authDeptList:[{required:!0,message:"请选择多部门",trigger:"change"}],menuDeptList:[{required:!0,message:"请选择部门访问菜单",trigger:"change"}]},ue=async e=>{try{const l=await s(e);if(l&&200==l.code&&l.data)return{current:l.data.current,total:l.data.total,data:l.data.records}}catch(l){}return{current:1,total:0,data:[]}},se=c((()=>e=>{let l=JSON.parse(JSON.stringify(ae.menulist));const a=[];return ae.ruleForm.menuSqlList.map((e=>{e.sqlMenuList.map((e=>{a.push(e)}))})),l.map((l=>a.indexOf(l.menuId)>-1&&-1==e.indexOf(l.menuId)?(l.disabled=!0,l):(l.disabled=!1,l))),l})),re=()=>{ae.ruleForm.linkGroup="",ae.ruleForm.linkuserId=""},ie=e=>{ae.ruleForm.linkUser=e},ne=()=>{ae.ruleForm.menuSqlList.push({diySql:"",sqlMenuList:[]})},oe=(e,l,a=null)=>{const t=[];return 0==l?null!=a?e.forEach((e=>{t.push({menuId:e,type:a})})):e.forEach((e=>{t.push({menuId:e})})):1==l&&e.forEach((e=>{t.push({deptId:e})})),t},de=m(!1),me=async()=>{if((()=>{let e=!1;return ae.ruleForm.menuSqlList.map((l=>{(!l.diySql&&l.sqlMenuList.length>0||l.diySql&&0==l.sqlMenuList.length)&&(e=!0)})),e})())return void a.error("请填写完整自定义规则");let e=ae.ruleForm.menuSqlList.filter((e=>""!=e.diySql&&e.sqlMenuList.length>0));const l={sysDataAuth:{id:ae.ruleForm.id,linkType:ae.ruleForm.linkType,linkId:"0"==ae.ruleForm.linkType?ae.ruleForm.linkGroup.value:ae.ruleForm.linkuserId,linkName:"0"==ae.ruleForm.linkType?ae.ruleForm.linkGroup.label:ae.ruleForm.linkUser.nickname,isCreateAuth:ae.ruleForm.menuCreateList.length>0?1:0,isSettleAuth:ae.ruleForm.menuSettleList.length>0?1:0,isDeptAuth:ae.ruleForm.isDeptAuth,isDiySql:e.length>0?1:0},menuCreateList:oe(ae.ruleForm.menuCreateList,0,0),menuSettleList:oe(ae.ruleForm.menuSettleList,0,1),menuDeptList:oe(ae.ruleForm.menuDeptList,0,2),authDeptList:oe(ae.ruleForm.authDeptList,1),authSqlList:e.length>0?e.map((e=>({diySql:e.diySql,sqlMenuList:oe(e.sqlMenuList,0)}))):[]};g.value.validate((async e=>{e&&(de.value=!0,o(l).then((e=>{200==e.code?(a.success("数据权限编辑成功"),pe()):a.error(e.msg)}))["catch"]((e=>{}))["finally"]((()=>{de.value=!1})))}))},pe=()=>{le.push({path:"/system/permission/index",query:{}}),C(U,"/system/permission/index"),u(ee,U)};return h((async()=>{let e=await l("group_type");200==e.code?ae.userGroupList=e.data:(ae.userGroupList=[],a.error(e.msg));let u=await t({flag:0});200==u.code?ae.menulist=u.data:(ae.menulist=[],a.error(u.msg));const s=await i();200==s.code?ae.deptTree=s.data:(ae.deptlist=[],a.error(s.msg)),ee.query.id&&n(ee.query.id).then((e=>{200==e.code?(ae.ruleForm.id=e.data.sysDataAuth.id,ae.ruleForm.linkType=e.data.sysDataAuth.linkType.toString(),ae.ruleForm.linkGroup="0"==e.data.sysDataAuth.linkType?{value:e.data.sysDataAuth.linkId,label:e.data.sysDataAuth.linkName}:null,ae.ruleForm.linkuserId="1"==e.data.sysDataAuth.linkType?e.data.sysDataAuth.linkId:null,ae.ruleForm.linkUser="1"==e.data.sysDataAuth.linkType?{nickname:e.data.sysDataAuth.linkName}:null,ae.options="1"==e.data.sysDataAuth.linkType?[{userId:e.data.sysDataAuth.linkId,nickname:e.data.sysDataAuth.linkName}]:[],ae.ruleForm.isDeptAuth=e.data.sysDataAuth.isDeptAuth.toString(),ae.ruleForm.menuCreateList=e.data.menuCreateList?e.data.menuCreateList.map((e=>e.menuId)):[],ae.ruleForm.menuSettleList=e.data.menuSettleList?e.data.menuSettleList.map((e=>e.menuId)):[],ae.ruleForm.menuDeptList=e.data.menuDeptList?e.data.menuDeptList.map((e=>e.menuId)):[],ae.ruleForm.authDeptList=e.data.authDeptList?e.data.authDeptList.map((e=>e.deptId)):[],ae.ruleForm.menuSqlList=e.data.authSqlList?e.data.authSqlList.map((e=>({diySql:e.diySql,sqlMenuList:e.sqlMenuList.map((e=>e.menuId))}))):[{diySql:"",sqlMenuList:[]}]):a.error(e.msg)}))["catch"]((e=>{}))})),(e,l)=>{const a=v("el-radio"),t=v("el-radio-group"),u=v("el-form-item"),s=v("el-option"),i=v("el-select"),n=v("el-tree-select"),o=v("el-input"),m=v("el-form"),p=v("el-button");return D(),y("div",x,[k("div",M,[k("div",G,[j,k("div",N,[L(m,{model:ae.ruleForm,ref_key:"ruleForm",ref:g,rules:te,size:"default","label-width":"120px","label-position":"right"},{"default":f((()=>[L(u,{label:"选择关联账号",prop:"linkType"},{"default":f((()=>[L(t,{modelValue:ae.ruleForm.linkType,"onUpdate:modelValue":l[0]||(l[0]=e=>ae.ruleForm.linkType=e),onChange:re,disabled:""},{"default":f((()=>[L(a,{label:"0"},{"default":f((()=>[z])),_:1}),L(a,{label:"1"},{"default":f((()=>[O])),_:1})])),_:1},8,["modelValue"])])),_:1}),0==ae.ruleForm.linkType?(D(),_(u,{key:0,label:"",prop:"linkGroup"},{"default":f((()=>[L(i,{disabled:"",modelValue:ae.ruleForm.linkGroup,"onUpdate:modelValue":l[1]||(l[1]=e=>ae.ruleForm.linkGroup=e),placeholder:"请选择用户组",clearable:"",filterable:"","class":"w650","value-key":"value"},{"default":f((()=>[(D(!0),y(S,null,I(ae.userGroupList,(e=>(D(),_(s,{key:e.value,label:e.label,value:{value:e.value,label:e.label}},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(D(),_(u,{key:1,label:"",prop:"linkuserId"},{"default":f((()=>[L(d,{ref_key:"pageSelectRef",ref:F,modelValue:ae.ruleForm.linkuserId,"onUpdate:modelValue":l[2]||(l[2]=e=>ae.ruleForm.linkuserId=e),request:ue,title:"nickname",search:"nickname","value-key":"userId",placeholder:"请选择用户",options:ae.options,selectwidth:"width:650px",onChange:ie,disabled:""},null,8,["modelValue","options"])])),_:1})),L(u,{label:"创建人访问"},{"default":f((()=>[L(i,{modelValue:ae.ruleForm.menuCreateList,"onUpdate:modelValue":l[3]||(l[3]=e=>ae.ruleForm.menuCreateList=e),multiple:"",placeholder:"请选择创建人访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":f((()=>[(D(!0),y(S,null,I(ae.menulist,(e=>(D(),_(s,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),L(u,{label:"项目权限访问"},{"default":f((()=>[L(i,{modelValue:ae.ruleForm.menuSettleList,"onUpdate:modelValue":l[4]||(l[4]=e=>ae.ruleForm.menuSettleList=e),multiple:"",placeholder:"请选择项目访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":f((()=>[(D(!0),y(S,null,I(ae.menulist,(e=>(D(),_(s,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),L(u,{label:"部门访问权限"},{"default":f((()=>[L(t,{modelValue:ae.ruleForm.isDeptAuth,"onUpdate:modelValue":l[5]||(l[5]=e=>ae.ruleForm.isDeptAuth=e)},{"default":f((()=>[L(a,{label:"0",size:"large"},{"default":f((()=>[P])),_:1}),L(a,{label:"1",size:"large"},{"default":f((()=>[E])),_:1}),L(a,{label:"2",size:"large"},{"default":f((()=>[R])),_:1})])),_:1},8,["modelValue"])])),_:1}),"0"!=ae.ruleForm.isDeptAuth?(D(),_(u,{key:2,label:"",prop:"menuDeptList"},{"default":f((()=>[L(i,{modelValue:ae.ruleForm.menuDeptList,"onUpdate:modelValue":l[6]||(l[6]=e=>ae.ruleForm.menuDeptList=e),multiple:"",placeholder:"请选择部门访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":f((()=>[(D(!0),y(S,null,I(ae.menulist,(e=>(D(),_(s,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):V("",!0),"2"==ae.ruleForm.isDeptAuth?(D(),_(u,{key:3,label:"",prop:"authDeptList"},{"default":f((()=>[L(n,{modelValue:ae.ruleForm.authDeptList,"onUpdate:modelValue":l[7]||(l[7]=e=>ae.ruleForm.authDeptList=e),ref_key:"deptRef",ref:T,data:ae.deptTree,props:ae.menuProps,"node-key":"id","show-checkbox":"",placeholder:"请选择多部门","class":"menu-data-tree w650","check-strictly":"",filterable:"",multiple:""},null,8,["modelValue","data","props"])])),_:1})):V("",!0),k("div",J,[Q,k("div",W,[(D(!0),y(S,null,I(ae.ruleForm.menuSqlList,((e,l)=>(D(),y("div",{"class":"sql_content",key:l},[k("div",$,[k("div",B,[L(i,{modelValue:e.sqlMenuList,"onUpdate:modelValue":l=>e.sqlMenuList=l,placeholder:"请选择自定义菜单",multiple:"",clearable:"",filterable:"",style:{width:"100%","margin-bottom":"12px"},"collapse-tags":"","collapse-tags-tooltip":""},{"default":f((()=>[(D(!0),y(S,null,I(A(se)(e.sqlMenuList),(e=>(D(),_(s,{key:e.menuId,label:e.name,value:e.menuId,disabled:e.disabled},null,8,["label","value","disabled"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"]),L(o,{modelValue:e.diySql,"onUpdate:modelValue":l=>e.diySql=l,type:"textarea",placeholder:"请输入自定义SQL语句",autosize:{minRows:2,maxRows:6}},null,8,["modelValue","onUpdate:modelValue"])]),ae.ruleForm.menuSqlList.length>1?(D(),y("div",H)):V("",!0)]),k("div",K,[0==l?(D(),_(r,{key:0,name:"iconfont icon-ic_edit_add",onClick:ne})):(D(),_(r,{key:1,name:"iconfont icon-ic_edit_delete",onClick:e=>{return a=l,void ae.ruleForm.menuSqlList.splice(a,1);var a}},null,8,["onClick"]))])])))),128))])])])),_:1},8,["model"])])]),k("div",X,[L(p,{onClick:pe},{"default":f((()=>[Y])),_:1}),L(p,{type:"primary",loading:de.value,onClick:me},{"default":f((()=>[Z])),_:1},8,["loading"])])])])}}},[["__scopeId","data-v-ed58e97a"]]);export{ee as default};