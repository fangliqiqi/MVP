import{g as e}from"./staff.1672389691407.js";import{b as l,c as a,u as r,f as o}from"./attach.1672389691407.js";import{g as t}from"./file.1672389691407.js";import{P as d}from"./index.16723896914073.js";import m from"./attachUpload.1672389691407.js";import{E as s}from"./index.1672389691407.js";import{d as i,f as u,$ as p,k as n,c,W as f,P as g,a3 as h,o as F,a as b,F as j,a5 as V,O as _,u as v,U as w}from"./vue.1672389691407.js";const y={"class":"system-add-dic-container"},k={"class":"dialog-footer"},I=w("取 消"),x=w("确 定"),C=i({name:"addBadness"}),L=Object.assign(C,{emits:["ok"],setup(i,{expose:w,emit:C}){const L=u(null),N=u(null),U=u(null),O=p({isShowDialog:!1,loading:!1,id:null,title:"新增不良记录",ruleForm:{empId:"",empName:"",empIdcard:"",project:"",projectCode:"",happenTime:"",loseFee:"",loseFeeOther:"",remark:"",attaIds:""},fileList:[],options:[],projectList:[]}),D={empName:[{required:!0,message:"请选择员工",trigger:"change"}],project:[{required:!0,message:"请选择项目",trigger:"change"}],happenTime:[{required:!0,message:"请选择发生时间",trigger:"blur"}],remark:[{required:!0,message:"请输入不良记录",trigger:"blur"}]},S=n((()=>O.ruleForm.loseFeeOther?(L.value&&L.value.clearValidate(["loseFee"]),[{pattern:/^\d{1,20}(\.\d{1,2})?$/,message:"请输入正确的数字,最多两位小数",trigger:"blur"}]):[{required:!0,message:"请输入费用损失",trigger:"blur"},{pattern:/^\d{1,20}(\.\d{1,2})?$/,message:"请输入正确的数字,最多两位小数",trigger:"blur"}])),T=n((()=>O.ruleForm.loseFee?(L.value&&L.value.clearValidate(["loseFeeOther"]),[{pattern:/^\d{1,20}(\.\d{1,2})?$/,message:"请输入正确的数字,最多两位小数",trigger:"blur"}]):[{required:!0,message:"请输入其他费用损失",trigger:"blur"},{pattern:/^\d{1,20}(\.\d{1,2})?$/,message:"请输入正确的数字,最多两位小数",trigger:"blur"}])),q=e=>{O.fileList=e.value},R=e=>{O.fileList=e.value},$=async l=>{try{l.fileStatus=0;const a=await e(l);if(a&&200==a.code&&a.data)return{current:a.data.current,total:a.data.total,data:a.data.records};s.error(a.msg)}catch(a){}return{current:1,total:0,data:[]}},z=async e=>{O.ruleForm.empId=e.id,O.ruleForm.empIdcard=e.empIdcard,O.projectList=[],O.ruleForm.project="",O.ruleForm.projectCode="",O.options=[e],e.empIdcard&&await Y(e.empIdcard)},Y=e=>{a({empIdCard:e}).then((e=>{if(200==e.code)for(let l in e.data)O.projectList.push({label:l,value:e.data[l]});else s.error(e.msg||"获取产生项目列表失败")}))["catch"]((e=>{s.error(e.msg||"获取产生项目列表失败")}))},P=e=>{O.ruleForm.project=e.label,O.ruleForm.projectCode=e.value},E=e=>e.getTime()>Date.now(),M=async e=>{try{const a=await l(e);if(a&&200===a.code){const e={...a.data};O.options=[{empIdcard:e.empIdcard,empName:e.empName}],O.ruleForm=e,O.isShowDialog=!0}else s.error(a.msg||"获取不良记录详情失败");const r=await t(e);r&&200===r.code?O.fileList=r.data.map((e=>(e.name=e.attaName,e.uid=e.id,e.url=e.attaUrl,e))):(O.fileList=[],s.error(r.msg||"获取附件失败"))}catch(a){B()}},B=()=>{L.value.resetFields(),L.value.clearValidate(),O.ruleForm={empId:"",empName:"",empIdcard:"",project:"",projectCode:"",happenTime:"",loseFee:"",loseFeeOther:"",remark:"",attaIds:""},O.isShowDialog=!1,O.loading=!1},W=()=>{B()},A=()=>{L.value.validate((e=>{if(e){if(!O.ruleForm.loseFee&&!O.ruleForm.loseFeeOther)return void s.warning("费用损失和其他损失不可同时为空");O.loading=!0;const e=[];O.fileList.forEach((l=>{e.push(l.uid)})),O.ruleForm.attaIds=e.join(","),null!==O.id&&void 0!==O.id?r(O.ruleForm).then((e=>{e&&200==e.code?(s.success("编辑不良记录成功"),C("ok"),B()):s.error(e.msg||"编辑不良记录失败")}),(()=>{s.error("编辑不良记录失败")}))["finally"]((()=>{O.loading=!1})):o(O.ruleForm).then((e=>{e&&200==e.code?(s.success("新增不良记录成功"),C("ok"),B()):s.error(e.msg||"新增不良记录失败")}),(e=>{const l=e&&e.msg||"新增不良记录失败";s.error(l)}))["finally"]((()=>{O.loading=!1}))}}))};return w({openDialog:async e=>{e&&e.id?(O.title="编辑不良记录",O.id=e.id,await M(e.id)):(O.title="新增不良记录",O.id=null,O.ruleForm={empId:"",empName:"",empIdcard:"",project:"",projectCode:"",happenTime:"",loseFee:"",loseFeeOther:"",remark:"",attaIds:""},O.fileList=[],O.isShowDialog=!0)}}),(e,l)=>{const a=h("el-form-item"),r=h("el-col"),o=h("el-input"),t=h("el-option"),s=h("el-select"),i=h("el-date-picker"),u=h("el-row"),p=h("el-form"),n=h("el-button"),w=h("el-dialog");return F(),c("div",y,[f(w,{title:O.title,modelValue:O.isShowDialog,"onUpdate:modelValue":l[8]||(l[8]=e=>O.isShowDialog=e),"close-on-click-modal":!1,width:"816px",onClose:B},{footer:g((()=>[b("span",k,[f(n,{onClick:W,size:"default"},{"default":g((()=>[I])),_:1}),f(n,{type:"primary",onClick:A,loading:O.loading,size:"default"},{"default":g((()=>[x])),_:1},8,["loading"])])])),"default":g((()=>[f(p,{ref_key:"formRef",ref:L,model:O.ruleForm,rules:D,size:"default","label-width":"110px"},{"default":g((()=>[f(u,null,{"default":g((()=>[f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"选择员工",prop:"empName"},{"default":g((()=>[f(d,{disabled:!!O.id,ref_key:"pageSelectRef",ref:N,modelValue:O.ruleForm.empName,"onUpdate:modelValue":l[0]||(l[0]=e=>O.ruleForm.empName=e),request:$,"value-key":"empName",title:"empName",search:"empName",placeholder:"请选择员工",options:O.options,onChange:z},null,8,["disabled","modelValue","options"])])),_:1})])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"身份证号"},{"default":g((()=>[f(o,{modelValue:O.ruleForm.empIdcard,"onUpdate:modelValue":l[1]||(l[1]=e=>O.ruleForm.empIdcard=e),placeholder:"身份证号",disabled:""},null,8,["modelValue"])])),_:1})])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"产生项目",prop:"project"},{"default":g((()=>[f(s,{modelValue:O.ruleForm.project,"onUpdate:modelValue":l[2]||(l[2]=e=>O.ruleForm.project=e),placeholder:"请选择项目",clearable:"",filterable:"",style:{width:"100%"},onChange:P,disabled:!(0!=O.projectList.length&&!O.id)},{"default":g((()=>[(F(!0),c(j,null,V(O.projectList,(e=>(F(),_(t,{key:e.value,label:e.label,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1})])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"项目编码"},{"default":g((()=>[f(o,{modelValue:O.ruleForm.projectCode,"onUpdate:modelValue":l[3]||(l[3]=e=>O.ruleForm.projectCode=e),placeholder:"项目编码",disabled:""},null,8,["modelValue"])])),_:1})])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"发生时间",prop:"happenTime"},{"default":g((()=>[f(i,{modelValue:O.ruleForm.happenTime,"onUpdate:modelValue":l[4]||(l[4]=e=>O.ruleForm.happenTime=e),type:"date",placeholder:"请选择发生时间",style:{width:"100%"},"value-format":"YYYY-MM-DD 00:00:00","disabled-date":E},null,8,["modelValue"])])),_:1})])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"费用损失",prop:"loseFee",rules:v(S)},{"default":g((()=>[f(o,{modelValue:O.ruleForm.loseFee,"onUpdate:modelValue":l[5]||(l[5]=e=>O.ruleForm.loseFee=e),placeholder:"请输入费用损失"},null,8,["modelValue"])])),_:1},8,["rules"])])),_:1}),f(r,{md:12,lg:12,xl:12},{"default":g((()=>[f(a,{label:"其他损失",prop:"loseFeeOther",rules:v(T)},{"default":g((()=>[f(o,{modelValue:O.ruleForm.loseFeeOther,"onUpdate:modelValue":l[6]||(l[6]=e=>O.ruleForm.loseFeeOther=e),placeholder:"请输入其他损失"},null,8,["modelValue"])])),_:1},8,["rules"])])),_:1}),f(r,{md:24,lg:24,xl:24},{"default":g((()=>[f(a,{label:"不良记录描述",prop:"remark"},{"default":g((()=>[f(o,{type:"textarea",modelValue:O.ruleForm.remark,"onUpdate:modelValue":l[7]||(l[7]=e=>O.ruleForm.remark=e),autosize:{minRows:2,maxRows:4},placeholder:"请输入不良记录","show-word-limit":"",maxlength:"200",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),f(u,{md:24,lg:24,xl:24},{"default":g((()=>[f(a,{label:"附件"},{"default":g((()=>[f(m,{ref_key:"attachUploadRef",ref:U,"file-list":O.fileList,onRemovefile:R,onChangefile:q,type:3,filePath:"badnessFile",domain:O.id},null,8,["file-list","domain"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])),_:1},8,["title","modelValue"])])}}});export{L as default};