import{s as e,_ as a,o as l,u as t,E as o,h as r}from"./index.1672389691407.js";import{v as d}from"./xlsx.1672389691407.js";import{e as s}from"./excel.1672389691407.js";import{P as i}from"./index.16723896914073.js";import{E as n}from"./header.1672389691407.js";import{d as u,$ as m,f as c,k as p,c as f,W as g,P as h,a3 as y,ai as b,o as x,a as v,Q as F,O as k,K as Y,u as V,F as _,a5 as S,I as w,a9 as D,L as z,U as I,V as M,T as C,ay as P,az as j,n as U}from"./vue.1672389691407.js";const N=e=>(P("data-v-fbe34da6"),e=e(),j(),e),$={"class":"batch-import-dialog"},O={style:{"margin-left":"3px"}},B={key:1,style:{padding:"10px 0"}},E=N((()=>v("div",{"class":"el-upload__text"},[
I("拖拽或"),
v("em",null,"点击上传")],-1))),q={"class":"el-upload__tip"},A=N((()=>v("div",{style:{"margin-left":"110px"}},[
v("span",{style:{"vertical-align":"text-bottom","font-size":"12px",color:"#aeaeae"}}," 导入的人员为原减档、减项人员时，“复档复项”控制是否对人员和项目进行恢复 ")],-1))),K={key:0,"class":"custom-loading-bar"},T={key:1,style:{"text-align":"center"}},L=N((()=>v("div",null,[
v("div",{style:{"font-size":"24px","text-align":"center",margin:"10px 0 25px"}},"导入反馈"),
v("span",null,[
I("操作完成！"),
v("br"),
I("已为您提供反馈结果")])],-1))),R={style:{color:"var(--el-color-primary)","margin-top":"15px",cursor:"pointer"}},W={"class":"dialog-footer"},X=I("取 消"),Z=I("确 定 "),H=u({name:"batchImportDialog"});var Q=a(Object.assign(H,{props:{title:{type:String,"default":"批量导入"},errName:{type:String,"default":""},download:{type:Boolean,"default":!1},width:{type:String,"default":"600px"},labelWidth:{type:String,"default":"110px"},valid:Function,demobilize:Boolean,demobilizeParamsName:String,url:String,header:[Array,Object],type:Number,batchName:String,errorHeader:Array,errorData:Function,customError:{type:Boolean,"default":!1},limitZipSize:{type:Number,"default":5},upload:Function,rules:Object,extParams:Array,dateFormatKeys:Object,ext:Object,customProcess:Boolean,cardCheck:Boolean,beforeFlag:Boolean,fileStream:Boolean},emits:["ok","changeStatus","changeFile"],setup(a,{expose:u,emit:P}){const j=a,N=m({isShowDialog:!1,loading:!1,ruleForm:{},state:0,error:null,rules:{file:[{required:!0,message:"请上传文件",trigger:"blur"}],demobilize:[{required:!0,message:"请选择是否复档复项",trigger:"blur"}]},span:24}),H=c(null),Q=c(null),G=p((()=>j.rules?Object.assign({},N.rules,j.rules):N.rules)),J=p((()=>j.extParams?(j.extParams.map((e=>{N.ruleForm[e.dataIndex]=e.value||e.defalutValue||""})),j.extParams.filter((e=>"header"===e.position))):null)),ee=p((()=>j.extParams?j.extParams.filter((e=>"footer"===e.position)):null)),ae=async e=>{var a;const l=e.file.raw,t=(e=>!!(e.size/1024/1024<j.limitZipSize))(e.file);if(!t)return{code:1,msg:`上传文件大小不能超过 ${j.limitZipSize}MB!`};const o=await d(l,j.header,null!=(a=j.type)?a:0);if(o&&o.code&&1==o.code)return{code:1,msg:"表格数据为空，请检查表格数据是否正确"};if(o){const e=["","/","-","."],a=["YYYY年MM月","YYYY年MM月DD日","YYYY年M月","YYYY年M月D日"],l=[["MMM","YYYY"],["YYYY","MM"],["YYYY","MM","DD"],["YYYY","M","D"],["M","D","YY"]].map((a=>e.map((e=>a.join(e))))).reduce(((e,a)=>e.concat(a)),a);return(o||[]).forEach((e=>{Object.keys(e).forEach((a=>{"string"==typeof e[a]&&(e[a]=e[a].trim());const t=j.dateFormatKeys&&j.dateFormatKeys[a];if(t&&e[a]&&e[a].length>5){const o=r(e[a],l,!0);if(-1===o.invalidAt()){const l=o.format(t||"YYYY-MM-DD");"Invalid date"!==l&&(e[a]=l)}}}))})),{code:200,data:o}}return{code:1,msg:"表头信息同模板不一致，请核实后重新上传"}},le=async()=>{try{let a=null;a=j.valid?await j.valid(N.ruleForm):await ae(N.ruleForm);const l={};if(j.demobilizeParamsName&&(l[j.demobilizeParamsName]=N.ruleForm.demobilize),a&&200===a.code){if(P("changeStatus",{state:"uploading"}),j.upload&&"function"==typeof j.upload){const e=await j.upload(N.ruleForm,a.data);return void(e&&200==e.code&&e.data&&e.data.length?(P("changeStatus",{state:"error"}),N.state=2,N.error=e.data,P("ok"),j.download&&se()):e&&e.data&&e.data.length?(P("changeStatus",{state:"error"}),P("ok"),N.state=2,N.error=e.data,j.download&&se()):e&&200==e.code?(P("changeStatus",{state:"success"}),P("ok"),o.success("批量操作成功"),de()):(P("ok"),o.error(e&&e.msg||"批量操作失败"),de()))}const t=new FormData;t.append("file",N.ruleForm.file.raw),j.demobilize&&t.append("isCanAdd",N.ruleForm.demobilize),J.value&&J.value.length>0&&J.value.map((e=>{l[e.dataIndex]=N.ruleForm[e.dataIndex]}));const r={"Content-Type":"multipart/form-data"},d=await function(a,l,t,o){return e({url:a,method:"post",data:l,params:t,headers:o,timeout:9e5})}(j.url,t,Object.assign({},l,j.ext||{}),r);d&&200==d.code&&d.data&&d.data.length?(P("changeStatus",{state:"error"}),N.state=2,N.error=d.data,P("ok"),j.download&&se()):d&&d.data&&d.data.length?(P("ok"),P("changeStatus",{state:"error"}),N.state=2,N.error=d.data,j.download&&se()):d&&200==d.code?(P("changeStatus",{state:"success"}),P("ok"),o.success("批量操作成功"),de()):(P("ok"),o.error(d.msg||"批量操作失败"),de())}else a&&1===a.code&&(P("changeStatus",{state:"error"}),o.error(a.msg||"批量操作失败"),de())}catch(a){P("changeStatus",{state:"error"}),o.error("批量操作失败"),de()}},te=()=>{0===N.state?H.value&&H.value.validate((e=>{e&&(N.state=1,setTimeout((()=>{le()}),2e3))})):2===N.state&&de()},oe=p((()=>{if(j.errName)return j.errName+"结果反馈";if(N.ruleForm.file){const e=N.ruleForm.file.name,a=String(e).lastIndexOf(".");return e.substring(0,a)+"结果反馈"}return"结果反馈"})),re=async e=>{let a=e.name;if(!/\.(xlsx|xls|XLSX|XLS)$/.test(a))return o.error("上传文件必须为excel文件，且为xlsx,xls格式"),N.ruleForm.file=null,!1;N.ruleForm.file=e,U((()=>{var e;null==(e=null==H?void 0:H.value)||e.validateField("file")})),P("changeFile",e)},de=()=>{setTimeout((()=>{H.value.resetFields()}),50),N.isShowDialog=!1,N.state=0,N.error=null,N.ruleForm={},j.extParams&&j.extParams.map((e=>{e.value=""}))},se=()=>{try{let e=n,a=null;j.customError?(e=j.errorHeader,a=j.errorData?j.errorData(j.batchName,N.error):N.error):a=N.error.map((e=>({line:e.lineNum,error:e.message}))),s(e,a,oe.value)}catch(e){o.error("结果反馈文件下载失败")}},ie=()=>{de()};return c(N.ruleForm),u({openDialog:async e=>{N.info=e,N.state=0,N.ruleForm={demobilize:j.demobilize?1:""},N.error=null,N.isShowDialog=!0,Q.value&&Q.value.map((e=>{try{e.refresh()}catch(a){}}))},openErrorDialog:async e=>{N.state=2,N.error=e,N.ruleForm.file={name:"批量删除"},N.isShowDialog=!0,j.download&&se()},closeDialog:de,setRuleform:e=>{N.ruleForm=e}}),(e,o)=>{const r=y("el-date-picker"),d=y("el-radio"),s=y("el-radio-group"),n=y("el-option"),u=y("el-select"),m=y("el-input"),c=y("el-form-item"),p=y("el-col"),P=y("el-icon"),U=y("el-upload"),ae=y("el-row"),le=y("el-form"),ne=y("el-button"),ue=y("el-dialog"),me=b("loading");return x(),f("div",$,[g(ue,{title:a.title,modelValue:N.isShowDialog,"onUpdate:modelValue":o[1]||(o[1]=e=>N.isShowDialog=e),width:j.width,onClose:de,"close-on-click-modal":!1},{footer:h((()=>[v("span",W,[g(ne,{onClick:ie,size:"default"},{"default":h((()=>[X])),_:1}),g(ne,{type:"primary",onClick:te,loading:N.loading,size:"default",disabled:1===N.state||j.cardCheck},{"default":h((()=>[Z])),_:1},8,["loading","disabled"])])])),"default":h((()=>[0===N.state||1===N.state?F((x(),k(le,{key:0,ref_key:"formRef",ref:H,model:N.ruleForm,rules:V(G),size:"default",style:{"padding-bottom":"40px"},"label-width":j.labelWidth},{"default":h((()=>[g(ae,{style:Y({marginTop:V(J)?"0px":"40px"})},{"default":h((()=>[V(J)?(x(!0),f(_,{key:0},S(V(J),((a,l)=>(x(),k(p,{key:`header_${l}`,span:a.span||N.span},{"default":h((()=>[a.dataIndex?(x(),k(c,{key:0,label:a.title,prop:a.dataIndex},{"default":h((()=>[a.custom?w(e.$slots,a.custom,D(z({key:0},a)),void 0,!0):a.type&&"page-select"===a.type?(x(),k(i,{key:1,ref_for:!0,ref_key:"pageSelectRef",ref:Q,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,request:a.config.request,"value-key":a.config.valueKey,title:a.config.title,search:a.config.search,placeholder:a.config.placeholder,onChange:a.config.onChange},null,8,["modelValue","onUpdate:modelValue","request","value-key","title","search","placeholder","onChange"])):"date"===a.type||"month"===a.type?(x(),k(r,{key:2,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,type:a.type,placeholder:a.config.placeholder,"disabled-date":a.config.disabledDate||null,format:a.config.format,"value-format":a.config.valueFormat,clearable:a.config.clearable||!0},null,8,["modelValue","onUpdate:modelValue","type","placeholder","disabled-date","format","value-format","clearable"])):"radio"==a.type?(x(),k(s,{key:3,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,onChange:a.config.onChange},{"default":h((()=>[(x(!0),f(_,null,S(a.radioData,((e,a)=>(x(),k(d,{label:a,key:a},{"default":h((()=>[I(M(e),1)])),_:2},1032,["label"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])):"select"==a.type?(x(),k(u,{key:4,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,placeholder:`请选择${a.title}`,disabled:a.disabled||!1,filterable:"",clearable:"",style:{width:"100%"},onChange:a.config.onChange},{"default":h((()=>[(x(!0),f(_,null,S(a.selectData,((e,l)=>(x(),k(n,{key:l,label:e[a.config.label]||e,value:e[a.config.value]||l},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","disabled","onChange"])):(x(),k(m,{key:5,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,clearable:""},null,8,["modelValue","onUpdate:modelValue"]))])),_:2},1032,["label","prop"])):C("",!0)])),_:2},1032,["span"])))),128)):C("",!0),g(p,{span:24},{"default":h((()=>[g(c,{label:"文件",prop:"file"},{"default":h((()=>[F((x(),k(U,{"class":"upload-demo",drag:"","auto-upload":!1,accept:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel","show-file-list":!1,"on-change":re,disabled:j.beforeFlag},{tip:h((()=>[v("div",q,"请按“"+M(a.title)+"”模板要求填写",1)])),"default":h((()=>[N.ruleForm.file?(x(),f(_,{key:0},[g(P,{style:{"vertical-align":"text-top"}},{"default":h((()=>[g(V(l))])),_:1}),v("span",O,M(N.ruleForm.file.name),1)],64)):(x(),f("div",B,[g(P,{"class":"el-icon--upload"},{"default":h((()=>[g(V(t))])),_:1}),E]))])),_:1},8,["disabled"])),[[me,j.beforeFlag]])])),_:1})])),_:1}),j.demobilize?(x(),k(p,{key:1},{"default":h((()=>[g(c,{label:"复档复项",prop:"demobilize"},{"default":h((()=>[g(u,{modelValue:N.ruleForm.demobilize,"onUpdate:modelValue":o[0]||(o[0]=e=>N.ruleForm.demobilize=e),placeholder:"请选择",clearable:"",style:{width:"100%"}},{"default":h((()=>[g(n,{label:"是",value:1}),g(n,{label:"否",value:0})])),_:1},8,["modelValue"])])),_:1}),A])),_:1})):C("",!0),V(ee)?(x(!0),f(_,{key:2},S(V(ee),(a=>(x(),k(p,{key:`header_${a.dataIndex}`},{"default":h((()=>[g(c,{label:a.title,prop:a.dataIndex},{"default":h((()=>[a.custom?w(e.$slots,a.custom,{key:0},void 0,!0):(x(),k(m,{key:1,modelValue:N.ruleForm[a.dataIndex],"onUpdate:modelValue":e=>N.ruleForm[a.dataIndex]=e,clearable:""},null,8,["modelValue","onUpdate:modelValue"]))])),_:2},1032,["label","prop"])])),_:2},1024)))),128)):C("",!0)])),_:3},8,["style"]),j.customProcess&&1===N.state?(x(),f("div",K,[w(e.$slots,"loading",{},void 0,!0)])):C("",!0)])),_:3},8,["model","rules","label-width"])),[[me,!j.customProcess&&1===N.state]]):2===N.state?(x(),f("div",T,[w(e.$slots,"error",{},(()=>[L]),!0),v("p",R,[v("a",{onClick:se},M(V(oe)+".xlsx"),1)])])):C("",!0),w(e.$slots,"default",{state:N.state},void 0,!0)])),_:3},8,["title","modelValue","width"])])}}}),[["__scopeId","data-v-fbe34da6"]]);export{Q as B};