import{_ as e,N as l,E as a,ao as t,c as r,ah as u,b as s}from"./index.1672389691407.js";import{g as i}from"./dept.1672389691407.js";import{a as o}from"./permission.1672389691407.js";import{P as n}from"./index.16723896914073.js";import{f as d,$ as m,k as p,j as c,c as h,a as f,W as y,P as k,ay as g,az as b,aA as L,aD as F,a3 as q,o as v,O as _,F as V,a5 as S,T as D,u as I,U as w,i as U}from"./vue.1672389691407.js";import{e as x}from"./events.1672389691407.js";const C=e=>(g("data-v-7c197e48"),e=e(),b(),e),T={"class":"system-dict-container"},G={"class":"arch-pro-layout page-container"},A={"class":"arch-pro-content-container"},M=C((()=>f("div",{"class":"per-title"},[
f("em"),
w(" 数据权限设置 ")],-1))),j={"class":"per-form"},z=w("按用户组"),N=w("按用户"),O=w("关闭"),P=w("本部门可见"),E=w("多部门可见"),R={"class":"sql"},J=C((()=>f("div",{"class":"sql_title"}," 自定义规则 ",-1))),Q={"class":"sql_body"},W={"class":"w650"},$={"class":"sql_left w650"},B={key:0,"class":"sql_line"},H={"class":"sql_right"},K={"class":"footer"},X=w("取消"),Y=w("保存");var Z=e({__name:"addPermission",setup(e){const g=d(null),b=d(null),w=d(null),{proxy:C}=U(),Z=L(),ee=F(),le=m({ruleForm:{linkType:"0",linkuserId:"",linkGroup:"",linkUser:"",menuCreateList:[],menuSettleList:[],isDeptAuth:"0",authDeptList:[],menuDeptList:[],menuSqlList:[{diySql:"",sqlMenuList:[]}]},menulist:[],userGroupList:[],deptTree:[],menuProps:{children:"children",label:"name"}}),ae={linkType:[{required:!0,message:"请选择关联账号",trigger:"change"}],linkGroup:[{required:!0,message:"请选择用户组关联账号",trigger:"change"}],linkuserId:[{required:!0,message:"请选择用户关联账号",trigger:"change"}],authDeptList:[{required:!0,message:"请选择多部门",trigger:"change"}],menuDeptList:[{required:!0,message:"请选择部门访问菜单",trigger:"change"}]},te=async e=>{try{const l=await u(e);if(l&&200==l.code&&l.data)return{current:l.data.current,total:l.data.total,data:l.data.records}}catch(l){}return{current:1,total:0,data:[]}},re=p((()=>e=>{let l=JSON.parse(JSON.stringify(le.menulist));const a=[];return le.ruleForm.menuSqlList.map((e=>{e.sqlMenuList.map((e=>{a.push(e)}))})),l.map((l=>a.indexOf(l.menuId)>-1&&-1==e.indexOf(l.menuId)?(l.disabled=!0,l):(l.disabled=!1,l))),l})),ue=()=>{le.ruleForm.linkGroup="",le.ruleForm.linkuserId=""},se=e=>{le.ruleForm.linkUser=e},ie=()=>{le.ruleForm.menuSqlList.push({diySql:"",sqlMenuList:[]})},oe=(e,l,a=null)=>{const t=[];return 0==l?null!=a?e.forEach((e=>{t.push({menuId:e,type:a})})):e.forEach((e=>{t.push({menuId:e})})):1==l&&e.forEach((e=>{t.push({deptId:e})})),t},ne=d(!1),de=async()=>{if((()=>{let e=!1;return le.ruleForm.menuSqlList.map((l=>{(!l.diySql&&l.sqlMenuList.length>0||l.diySql&&0==l.sqlMenuList.length)&&(e=!0)})),e})())return void a.error("请填写完整自定义规则");let e=le.ruleForm.menuSqlList.filter((e=>""!=e.diySql&&e.sqlMenuList.length>0));const l={sysDataAuth:{linkType:le.ruleForm.linkType,linkId:"0"==le.ruleForm.linkType?le.ruleForm.linkGroup.value:le.ruleForm.linkuserId,linkName:"0"==le.ruleForm.linkType?le.ruleForm.linkGroup.label:le.ruleForm.linkUser.nickname,isCreateAuth:le.ruleForm.menuCreateList.length>0?1:0,isSettleAuth:le.ruleForm.menuSettleList.length>0?1:0,isDeptAuth:Number(le.ruleForm.isDeptAuth),isDiySql:e.length>0?1:0},menuCreateList:oe(le.ruleForm.menuCreateList,0,0),menuSettleList:oe(le.ruleForm.menuSettleList,0,1),menuDeptList:oe(le.ruleForm.menuDeptList,0,2),authDeptList:oe(le.ruleForm.authDeptList,1),authSqlList:e.length>0?e.map((e=>({diySql:e.diySql,sqlMenuList:oe(e.sqlMenuList,0)}))):[]};g.value.validate((async e=>{e&&(ne.value=!0,o(l).then((e=>{200==e.code?(a.success("数据权限新增成功"),me()):a.error(e.msg)}))["catch"]((e=>{a.error(e)}))["finally"]((()=>{ne.value=!1})))}))},me=()=>{ee.push({path:"/system/permission/index",query:{}}),x(C,"/system/permission/index"),r(Z,C)};return c((async()=>{let e=await l("group_type");200==e.code?le.userGroupList=e.data:(le.userGroupList=[],a.error(e.msg));let r=await t({flag:0});200==r.code?le.menulist=r.data:(le.menulist=[],a.error(r.msg));let u=await i();200==u.code?le.deptTree=u.data:(le.deptlist=[],a.error(u.msg))})),(e,l)=>{const a=q("el-radio"),t=q("el-radio-group"),r=q("el-form-item"),u=q("el-option"),i=q("el-select"),o=q("el-tree-select"),d=q("el-input"),m=q("el-form"),p=q("el-button");return v(),h("div",T,[f("div",G,[f("div",A,[M,f("div",j,[y(m,{model:le.ruleForm,ref_key:"ruleForm",ref:g,rules:ae,size:"default","label-width":"120px","label-position":"right"},{"default":k((()=>[y(r,{label:"选择关联账号",prop:"linkType"},{"default":k((()=>[y(t,{modelValue:le.ruleForm.linkType,"onUpdate:modelValue":l[0]||(l[0]=e=>le.ruleForm.linkType=e),onChange:ue},{"default":k((()=>[y(a,{label:"0"},{"default":k((()=>[z])),_:1}),y(a,{label:"1"},{"default":k((()=>[N])),_:1})])),_:1},8,["modelValue"])])),_:1}),0==le.ruleForm.linkType?(v(),_(r,{key:0,label:"",prop:"linkGroup"},{"default":k((()=>[y(i,{modelValue:le.ruleForm.linkGroup,"onUpdate:modelValue":l[1]||(l[1]=e=>le.ruleForm.linkGroup=e),placeholder:"请选择用户组",clearable:"","class":"w650","value-key":"value"},{"default":k((()=>[(v(!0),h(V,null,S(le.userGroupList,(e=>(v(),_(u,{key:e.value,label:e.label,value:{value:e.value,label:e.label}},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(v(),_(r,{key:1,label:"",prop:"linkuserId"},{"default":k((()=>[y(n,{ref_key:"pageSelectRef",ref:b,modelValue:le.ruleForm.linkuserId,"onUpdate:modelValue":l[2]||(l[2]=e=>le.ruleForm.linkuserId=e),request:te,title:"nickname",search:"nickname","value-key":"userId",placeholder:"请选择用户",options:le.options,selectwidth:"width:650px",onChange:se},null,8,["modelValue","options"])])),_:1})),y(r,{label:"创建人访问"},{"default":k((()=>[y(i,{modelValue:le.ruleForm.menuCreateList,"onUpdate:modelValue":l[3]||(l[3]=e=>le.ruleForm.menuCreateList=e),multiple:"",placeholder:"请选择创建人访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":k((()=>[(v(!0),h(V,null,S(le.menulist,(e=>(v(),_(u,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),y(r,{label:"项目权限访问"},{"default":k((()=>[y(i,{modelValue:le.ruleForm.menuSettleList,"onUpdate:modelValue":l[4]||(l[4]=e=>le.ruleForm.menuSettleList=e),multiple:"",placeholder:"请选择项目访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":k((()=>[(v(!0),h(V,null,S(le.menulist,(e=>(v(),_(u,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),y(r,{label:"部门访问权限"},{"default":k((()=>[y(t,{modelValue:le.ruleForm.isDeptAuth,"onUpdate:modelValue":l[5]||(l[5]=e=>le.ruleForm.isDeptAuth=e)},{"default":k((()=>[y(a,{label:"0",size:"large"},{"default":k((()=>[O])),_:1}),y(a,{label:"1",size:"large"},{"default":k((()=>[P])),_:1}),y(a,{label:"2",size:"large"},{"default":k((()=>[E])),_:1})])),_:1},8,["modelValue"])])),_:1}),"0"!=le.ruleForm.isDeptAuth?(v(),_(r,{key:2,label:"",prop:"menuDeptList"},{"default":k((()=>[y(i,{modelValue:le.ruleForm.menuDeptList,"onUpdate:modelValue":l[6]||(l[6]=e=>le.ruleForm.menuDeptList=e),multiple:"",placeholder:"请选择部门访问菜单",clearable:"",filterable:"","class":"w650","collapse-tags":"","collapse-tags-tooltip":""},{"default":k((()=>[(v(!0),h(V,null,S(le.menulist,(e=>(v(),_(u,{key:e.menuId,label:e.name,value:e.menuId},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):D("",!0),"2"==le.ruleForm.isDeptAuth?(v(),_(r,{key:3,label:"",prop:"authDeptList"},{"default":k((()=>[y(o,{modelValue:le.ruleForm.authDeptList,"onUpdate:modelValue":l[7]||(l[7]=e=>le.ruleForm.authDeptList=e),ref_key:"deptRef",ref:w,data:le.deptTree,props:le.menuProps,"node-key":"id","show-checkbox":"",placeholder:"请选择多部门","class":"menu-data-tree w650","check-strictly":"",filterable:"",multiple:""},null,8,["modelValue","data","props"])])),_:1})):D("",!0),f("div",R,[J,f("div",Q,[(v(!0),h(V,null,S(le.ruleForm.menuSqlList,((e,l)=>(v(),h("div",{"class":"sql_content",key:l},[f("div",W,[f("div",$,[y(i,{modelValue:e.sqlMenuList,"onUpdate:modelValue":l=>e.sqlMenuList=l,placeholder:"请选择自定义菜单",multiple:"",clearable:"",filterable:"",style:{width:"100%","margin-bottom":"12px"},"collapse-tags":"","collapse-tags-tooltip":""},{"default":k((()=>[(v(!0),h(V,null,S(I(re)(e.sqlMenuList),(e=>(v(),_(u,{key:e.menuId,label:e.name,value:e.menuId,disabled:e.disabled},null,8,["label","value","disabled"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue"]),y(d,{modelValue:e.diySql,"onUpdate:modelValue":l=>e.diySql=l,type:"textarea",placeholder:"请输入自定义SQL语句",autosize:{minRows:2,maxRows:6}},null,8,["modelValue","onUpdate:modelValue"])]),le.ruleForm.menuSqlList.length>1?(v(),h("div",B)):D("",!0)]),f("div",H,[0==l?(v(),_(s,{key:0,name:"iconfont icon-ic_edit_add",onClick:ie})):(v(),_(s,{key:1,name:"iconfont icon-ic_edit_delete",onClick:e=>{return a=l,void le.ruleForm.menuSqlList.splice(a,1);var a}},null,8,["onClick"]))])])))),128))])])])),_:1},8,["model"])])]),f("div",K,[y(p,{onClick:me},{"default":k((()=>[X])),_:1}),y(p,{type:"primary",loading:ne.value,onClick:de},{"default":k((()=>[Y])),_:1},8,["loading"])])])])}}},[["__scopeId","data-v-7c197e48"]]);export{Z as default};