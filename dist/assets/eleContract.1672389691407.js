import{P as e}from"./ProTable.1672389691407.js";import{g as a,t,s as r,a as s,r as d,b as n,c as o,d as i,e as l,f as c,h as m,i as p}from"./eleContract.16723896914072.js";import{P as u}from"./index.16723896914072.js";import{a as h}from"./city.1672389691407.js";import{_ as g,g as f,f as I,d as y,E as x,a as b}from"./index.1672389691407.js";import{B as S}from"./index.16723896914077.js";import{a6 as w,E as v}from"./header.1672389691407.js";import{r as k}from"./xlsx.1672389691407.js";import{d as _,f as W,j,$ as T,c as E,W as C,P as Y,u as D,a3 as P,o as N,a as M,U as O,ay as R,az as B}from"./vue.1672389691407.js";import"./index.16723896914073.js";import"./index.16723896914074.js";import"./excel.1672389691407.js";const U=e=>(R("data-v-14bbcc34"),e=e(),B(),e),G={"class":"contract-apply-container"},L={"class":"el-dropdown-link"},H=O(" 模板下载 "),F=U((()=>M("a",{href:"/template/电子合同导入模板.xls",download:""}," 批量导入模板",-1))),q=_({name:"电子合同"});var z=g(Object.assign(q,{setup(g){const _=W(null),O=W(null),R=W(null),B=()=>{V.params={}};j((()=>{U();const e=h();V.areaJson=e}));const U=async()=>{try{const e=await f(V.dictKeys);e&&(V.DICTS=e,V.columns=V.columns.map((a=>{const t={...a};if("type"===a.dataIndex)t.valueEnum=e.personnel_type;return t})),_.value&&_.value.refresh())}catch(e){}},q=async e=>{try{const t=Object.assign({},e,V.params);delete t.fileAddress;const r=await a(t);if(r&&200==r.code&&r.data)return{current:r.data.current,total:r.data.total,data:r.data.records}}catch(t){}return{current:1,total:0,data:[]}},z=()=>{_.value&&_.value.refresh()},A=async(e,a)=>{const l=y.service({lock:!0,text:"请求中...",background:"rgba(0, 0, 0, 0.7)","custom-class":"dept-global-loading"});switch(e){case"send":i(a.id).then((e=>{e&&200==e.code?(x.success("操作成功"),z()):x.error(e.msg||"操作失败")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"sign":o(a.fddContractId).then((e=>{e&&200==e.code?(x.success("操作成功"),z()):x.error(e.msg||"操作失败")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"seal":n(a.fddContractId).then((e=>{if(e&&200==e.code){let a="";const t=e.data.company||[];t&&t.length&&(a=t[0].signUrl),a?(window.open(a),x.success("操作成功"),z()):x.error("文件地址有误！")}else x.error(e.msg||"接口请求出错！")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"resign":d(a.fddContractId).then((e=>{e&&200==e.code?(x.success("操作成功"),z()):x.error(e.msg||"操作失败")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"preview":s(a.fddContractId).then((e=>{e&&200==e.code?(x.success("操作成功"),window.open(e.data),z()):x.error(e.msg||"操作失败")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"download":r(a.fddContractId).then((e=>{const a=e,t=new FileReader;t.onload=function(){try{const e=JSON.parse(t.result);let a="下载失败";return e.msg&&(a+=`,${e.msg}`),void x.error(a)}catch(a){const t=new Blob([e],{type:"application/zip"}),r=document.createElement("a"),s=window.URL.createObjectURL(t);r.href=s,r.download="签署文件.zip",document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(s)}},t.readAsText(a)}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;case"transfer":t(a.fddContractId).then((e=>{e&&200==e.code?(x.success(e.msg||"操作成功"),z()):x.error(e.msg||"操作失败")}),(e=>{x.error(e&&e.msg||"操作失败")}))["finally"]((()=>{l&&l.close()}));break;default:l&&l.close()}},J=async(e,a,t)=>{try{const r=[...(await k(e.raw))[0].data].map((e=>{const t=Object.keys(e),r={};return t.forEach((a=>{a.startsWith("__EMPTY")||(r[a]=e[a])})),r["法大大模板id"]=a.fddTemplateId,r}));return new Promise((async(e,a)=>{try{const s=await t(JSON.stringify(r)),d=s.message||s.msg||"导入失败";if(s&&s.data&&Array.isArray(s.data)&&s.data.length)e({code:1,msg:d,data:s.data});else if(s&&s.data&&"true"==s.data.allMatch){const t=s.data.data,r=`<div style="color:red">第${Object.keys(t).join("、")}行，${s.msg||"存在“在用的合同”"} </div><div style="margin-top:30px;">确定后将全部发送合同，否则合同信息不插入,修改后再全量导入，是否继续？ </div>`;b.confirm(r,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",dangerouslyUseHTMLString:!0}).then((async()=>{try{const a=await c(Object.values(t)),r=a.message||a.msg||"导入失败";a&&a.data&&a.data.length?e({code:1,msg:r,data:a.data}):a&&200==a.code?(x.success("操作成功"),e({code:200,msg:"导入成功",data:null})):e({code:1,msg:r,data:null})}catch(r){a({code:1,msg:"导入失败"})}}),(e=>{O.value&&O.value.closeDialog()}))["catch"]((()=>{O.value&&O.value.closeDialog()}))}else s&&200===s.code?e({code:200,msg:"导入成功",data:null}):e({code:1,msg:d,data:null})}catch(s){a({code:1,msg:"导入失败"})}}))}catch(r){return{code:1,msg:"导入失败"}}},$=(e,a)=>a.map((e=>{const a=e.message;return{line:e.lineNum,isError:a?"是":"否",error:a}})),K=async e=>{const{file:a}=e;return await J(a,e,m)},Q=async e=>{const{file:a}=e;return await J(a,e,p)},V=T({areaJson:null,batchExtParams:[{dataIndex:"fddTemplateId",title:"合同模板",position:"header",type:"page-select",config:{request:async e=>{try{const a=await l(e);if(a&&200==a.code&&a.data)return{current:a.data.current,total:a.data.total,data:a.data.records};x.error(a.msg)}catch(a){}return{current:1,total:0,data:[]}},valueKey:"fddTemplateId",title:"localName",search:"localName",placeholder:"请选择合同模板",onChange:e=>{}}}],batchRules:{fddTemplateId:[{required:!0,message:"请选择合同模板",trigger:"change"}]},areaProps:{label:"areaName",isLeaf:"isLeaf",children:"children"},dictKeys:["personnel_type"],params:{},searchConfig:{labelWidth:110,option:{extBtn:"extBtns"}},btn:[{label:"批量导入",onClick:()=>{O.value&&O.value.openDialog()},permission:["employee_batch_import"],icon:"icon-ic_edit_upload"}],cellBtns:[{text:"发送合同",prop:"send",permission:["demo_fddcontracttemplate_edit"],tooltip:"当前状态不可操作",isGray:e=>null!=e.fddContractId},{text:"发送签署",prop:"sign",permission:["demo_fddcontracttemplate_preview"],tooltip:"当前状态不可操作",isGray:e=>!(null!=e.draftId&&null==e.signTaskId)},{text:"盖章",prop:"seal",permission:["demo_fddcontracttemplate_preview"],tooltip:"当前状态不可操作",isGray:e=>!(2===Number(e.receiveSignStatus)&&1===Number(e.sendSignStatus))},{text:"作废重签",prop:"resign",permission:["demo_fddcontracttemplate_upkeep"],tooltip:"当前状态不可操作",isGray:e=>!(2!==Number(e.sendSignStatus)&&null!=e.taskId)},{text:"签署文件预览",prop:"preview",tooltip:"当前状态不可操作",isGray:e=>!e.signTaskId},{text:"签署文件下载",prop:"download",tooltip:"当前状态不可操作",isGray:e=>!e.signTaskId},{text:"转移附件到合同",prop:"transfer",tooltip:"当前状态不可操作",isGray:e=>!(0==e.isMove&&e.signTaskId&&2==e.signStatus)}],columns:[{dataIndex:"empName",title:"员工姓名",minWidth:160,tooltip:!0},{dataIndex:"empIdcard",title:"身份证号",minWidth:180},{dataIndex:"departNo",title:"项目编码",hideInSearch:!0,minWidth:160,ellipsis:!0},{dataIndex:"empPhone",title:"手机号码",minWidth:160,hideInSearch:!0},{dataIndex:"contractStart",title:"合同起始日期",dateFormat:"YYYY-MM-DD",minWidth:160,hideInSearch:!0},{dataIndex:"contractEnd",title:"合同截止日期",minWidth:160,hideInSearch:!0,dateFormat:"YYYY-MM-DD",ellipsis:!0},{dataIndex:"periodStart",title:"合同试用期开始时间",dateFormat:"YYYY-MM-DD",minWidth:160,hideInSearch:!0,ellipsis:!0},{dataIndex:"periodEnd",title:"合同试用期结束时间",dateFormat:"YYYY-MM-DD",minWidth:160,hideInSearch:!0,ellipsis:!0},{dataIndex:"periodSalaryPerMonth",title:"试用期工资",minWidth:160,hideInSearch:!0,ellipsis:!0},{dataIndex:"salaryType",title:"工资形式",minWidth:160,hideInSearch:!0,ellipsis:!0,valueEnum:{1:"计时工资",2:"计件工资",3:"其他"}},{dataIndex:"salaryStandardPerHour",title:"计时工资",minWidth:160,hideInSearch:!0,ellipsis:!0},{dataIndex:"salaryStandardPerPiece",title:"计件工资",minWidth:160,hideInSearch:!0,ellipsis:!0},{dataIndex:"workSpace",title:"工作地点",hideInSearch:!0,minWidth:180},{dataIndex:"taskId",title:"定稿任务发送状态",hideInSearch:!0,minWidth:180,formatter:e=>null==e.taskId?"未发送":"已发送"},{dataIndex:"signTaskId",title:"签署任务发送状态",hideInSearch:!0,minWidth:180,formatter:e=>null==e.signTaskId?"未发送":"已发送"},{dataIndex:"signStatus",title:"签署状态",hideInSearch:!0,minWidth:180,valueEnum:{1:"未签署",2:"已签署",4:"已拒签",5:"已撤销"}},{dataIndex:"sendSignStatus",title:"签署发送方状态",hideInSearch:!0,minWidth:180,valueEnum:{1:"未签署",2:"已签署",3:"已拒签",4:"已撤销"}},{dataIndex:"receiveSignStatus",title:"签署接收方状态",hideInSearch:!0,valueType:"custom",minWidth:180,valueEnum:{1:"未签署",2:"已签署",3:"已拒签",4:"已撤销"}},{dataIndex:"taskStatus",title:"定稿状态",hideInSearch:!0,minWidth:180,valueEnum:{1:"未定稿",2:"定稿成功"}},{dataIndex:"remark",title:"定稿备注",hideInSearch:!0,minWidth:180},{dataIndex:"signRemark",title:"签署备注",hideInSearch:!0,minWidth:180},{dataIndex:"createName",title:"创建用户",hideInSearch:!0,minWidth:180},{dataIndex:"createTime",title:"创建时间",hideInSearch:!0,minWidth:180},{dataIndex:"option",title:"操作",key:"option",width:320,hideInSearch:!0,fixed:"right",scopedSlots:{customRender:"option"}}]});return(a,t)=>{const r=P("el-icon"),s=P("el-button"),d=P("el-dropdown-item"),n=P("el-dropdown-menu"),o=P("el-dropdown");return N(),E("div",G,[C(e,{ref_key:"proTableRef",ref:_,"row-key":"id",columns:V.columns,request:q,btn:V.btn,onOnReset:B,manualRequest:"",searchConfig:V.searchConfig},{option:Y((e=>[C(u,{array:V.cellBtns,model:e,onOnClick:A},null,8,["array","model"])])),extBtns:Y((()=>[C(o,{"class":"arch-btn","popper-class":"module-download"},{dropdown:Y((()=>[C(n,null,{"default":Y((()=>[C(d,null,{"default":Y((()=>[F])),_:1})])),_:1})])),"default":Y((()=>[M("span",L,[C(s,{size:"default"},{"default":Y((()=>[H,C(r,{"class":"el-icon--right"},{"default":Y((()=>[C(D(I))])),_:1})])),_:1})])])),_:1})])),_:1},8,["columns","btn","searchConfig"]),C(S,{ref_key:"batchImportDialog",ref:O,type:1,header:D(w),onOk:z,batchName:"ele-contract-batch-import",errorHeader:D(v),errorData:$,upload:K,"ext-params":V.batchExtParams,rules:V.batchRules,customError:"",download:""},null,8,["header","errorHeader","ext-params","rules"]),C(S,{title:"批量更新",type:1,ref_key:"batchUpdateDialog",ref:R,header:D(w),upload:Q,onOk:z,batchName:"ele-contract-batch-update",errorHeader:D(v),errorData:$,"ext-params":V.batchExtParams,rules:V.batchRules,customError:"",download:""},null,8,["header","errorHeader","ext-params","rules"])])}}}),[["__scopeId","data-v-14bbcc34"]]);export{z as default};